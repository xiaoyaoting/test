const get = require('lodash/get');

// Format context: https://github.com/graphql/express-graphql
module.exports = (ctx = {}) => {
  if (ctx && ctx.user) {
    delete ctx.user.avatar;
  }

  const safeGet = (key, _default = '') =>
    (typeof ctx.get === 'function' ? ctx.get(key) : get(ctx, `headers[${key}]`)) || _default;
  const port = process.env.NODE_ENV === 'production' ? safeGet('x-real-port') : '';
  const result = {
    ip: safeGet('x-real-ip', '127.0.0.1'),
    ua: safeGet('user-agent'),
    protocol: safeGet('x-real-protocol').replace(/:$/, '') || 'http',
    user: ctx.user || {},
    url: ctx.originalUrl,
    query: ctx.query,
    hostname: safeGet('x-real-hostname'),
    port: Number(port) === 80 ? '' : Number(port),
  };

  return result;
};
