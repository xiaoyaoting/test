const axios = require('axios');
const debug = require('debug')('get-ec2-meta');

const HOST = 'http://169.254.169.254/latest';

// Link: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html
// Link: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-add-user-data.html
const getEc2Meta = async (key, timeout = 5000) => {
  const url = key === 'user-data' ? `${HOST}/${key}` : `${HOST}/meta-data/${key}`;

  try {
    const result = await axios.get(url, { timeout });
    debug('get ec2 meta', { key, status: result.status, data: result.data });
    if (result.status === 200) {
      return result.data;
    }

    return '';
  } catch (err) {
    debug('Failed to fetch ec2 meta', err.message);
    return '';
  }
};

module.exports = getEc2Meta;
