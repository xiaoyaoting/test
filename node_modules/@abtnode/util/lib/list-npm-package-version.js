const semverClean = require('to-semver');
const semverSort = require('semver-sort');
const axios = require('./axios');

module.exports = async (name, { includePrereleases = false, limit = 10 } = {}) => {
  const {
    data: { time, versions },
  } = await Promise.race([
    axios.get(`https://registry.npmjs.org/${name}`),
    axios.get(`https://registry.npm.taobao.org/${name}`),
  ]);
  const valid = semverSort.desc(semverClean(Object.keys(time), { includePrereleases, clean: true }));

  const result = valid
    .filter((x) => !versions[x].deprecated)
    .map((version) => ({ version, publishedAt: time[version] }))
    .slice(0, limit);

  return result;
};
